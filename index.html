<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeetCode Daily History</title>

    <meta property="og:image" content="https://repository-images.githubusercontent.com/551211487/8c331e02-a4ec-49a5-a32d-37988bd3ebbc" />
    <meta property="og:site_name" content="Joric" />
    <meta property="og:type" content="object" />
    <meta property="og:title" content="Joric's Oneliners" />
    <meta property="og:description" content="LeetCode Daily History" />

    <!-- Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header-section { text-align: center; margin-bottom: 20px; position: relative; }
        h1 { color: #333; margin-bottom: 10px; }
        .summary-text { font-size: 1.1em; color: #555; line-height: 1.5; margin-bottom: 20px;}
        #loading { text-align: center; font-size: 1.5em; color: #666; margin-top: 50px; }
        
        /* --- Search Box Styles --- */
        .search-wrapper {
            position: relative;
            max-width: 500px;
            margin: 0 auto 30px auto;
            z-index: 1000;
        }

        #search-input {
            width: 100%;
            padding: 12px 45px 12px 20px; 
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 25px;
            outline: none;
            transition: border-color 0.3s;
        }

        #search-input:focus {
            border-color: #448aff;
        }
        
        #search-input.selected::placeholder {
            color: #888; 
            font-weight: normal; 
        }

        #search-clear {
            position: absolute;
            right: 10px; 
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: #999;
            cursor: pointer;
            display: none; 
            width: 30px; 
            height: 30px; 
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            transition: background 0.2s, color 0.2s;
        }

        #search-clear:hover {
            color: #555;
            background: #e0e0e0; 
        }

        #search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1001; 
            display: none; 
            margin-top: 5px;
            text-align: left;
        }

        .search-item {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .search-item:last-child { border-bottom: none; }
        
        .search-item.active,
        .search-item:hover { background: #f4f6f8; }
        
        .search-item .id { color: #888; font-size: 0.9em; margin-right: 10px; min-width: 40px; text-align: right; }
        .search-item .title { font-weight: 500; color: #333; flex: 1; }
        .search-item .count { color: #888; font-size: 0.9em; text-align: right; }

        /* --- Chart Grid System --- */
        .stats-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-bottom: 20px; 
            margin-top: 60px; 
        }
        
        .chart-card { 
            background: white; 
            padding: 10px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            height: 450px; 
            width: 100%;
            overflow: hidden;
        }
        
        .full-width { grid-column: 1 / -1; }

        /* --- Calendar Grid System --- */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px; 
            transition: all 0.3s ease;
        }
        
        .month-card { 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .month-card.hidden {
            display: none;
        }

        .month-header { background: #2c3e50; color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 1.1em; }
        .days-container { display: grid; grid-template-columns: repeat(7, 1fr); padding: 10px; gap: 2px; }
        .day-name { text-align: center; font-size: 0.85em; color: #777; padding-bottom: 10px; font-weight: 600; }
        
        /* --- Day Cell Styles --- */
        .day-cell { 
            aspect-ratio: 1 / 1; 
            border: 1px solid #f0f0f0; 
            position: relative; 
            font-size: 0.95em; 
            cursor: pointer; 
            border-radius: 4px; 
            transition: transform 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .day-cell:hover:not(.empty) { 
            transform: scale(1.1); 
            z-index: 5; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
        }

        .day-cell.highlight-related {
            transform: scale(1.1) !important;
            z-index: 10 !important;
            border: 3px dotted #000 !important; 
            filter: brightness(1.05);
            box-shadow: none !important;
        }

        .day-cell.highlight-clicked-active {
            transform: scale(1.15) !important;
            z-index: 20 !important;
            border: 3px solid #000 !important; 
            filter: brightness(1.1);
            box-shadow: none !important; 
        }
        
        /* Main Number Link (GitHub) */
        .day-number { 
            text-decoration: none; 
            color: inherit; 
            width: 100%; 
            height: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 500;
        }
        
        .day-number-static { color: #ccc; font-weight: 400; }
        
        /* Occurrence Count Link (LeetCode) */
        .occ-count {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 0.7em;
            text-decoration: none;
            font-weight: bold;
            z-index: 5;
            opacity: 0.85;
        }
        .occ-count:hover { text-decoration: underline; opacity: 1; }

        .day-cell.empty { background: transparent; border: none; cursor: default; }
        
        /* Difficulty Colors */
        .Easy { background-color: #00b8a3; color: white; border-color: #00b8a3; }
        .Easy .occ-count { color: white; }
        
        .Medium { background-color: #ffc01e; color: black; border-color: #ffc01e; }
        .Medium .occ-count { color: rgba(0,0,0,0.7); }
        
        .Hard { background-color: #ff375f; color: white; border-color: #ff375f; }
        .Hard .occ-count { color: white; }
        
        @media (max-width: 1100px) {
            .calendar-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 900px) {
            .stats-grid { grid-template-columns: 1fr; }
            .chart-card { height: auto; min-height: 400px; padding-bottom: 20px; }
            .calendar-grid { grid-template-columns: repeat(1, 1fr); }
        }

        footer {
          padding: 36px;
          text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-section">
            <h1>LeetCode Daily Stats & Calendar</h1>
            <div id="summary" class="summary-text"></div>
            
            <div class="search-wrapper">
                <input type="text" id="search-input" placeholder="Search problems (e.g. 'Two Sum')..." autocomplete="off" autofocus>
                <span id="search-clear" title="Clear search">âœ•</span>
                <div id="search-results"></div>
            </div>
        </div>
        
        <div id="loading">Loading data...</div>

        <div id="content" style="display: none;">
            
            <div id="calendar" class="calendar-grid">
                <!-- Calendar generated by JS -->
            </div>

            <div class="stats-grid">
                <div class="chart-card"><div id="pieChart"></div></div>
                <div class="chart-card"><div id="freqChart"></div></div>
                <div class="chart-card full-width"><div id="heatmapChart"></div></div>
                <div class="chart-card full-width"><div id="recurChart"></div></div>
            </div>

        </div>
    </div>

    <footer>
      <a target="_blank" href="https://www.reddit.com/r/leetcode/comments/1dzcfap/i_did_an_analysis_of_every_daily_problem/">I did an analysis of every daily problem (Reddit)</a>
    </footer>
    
    <!-- Github Corner -->
    <a href="https://github.com/joric/oneliners/" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <script>
        const CSV_URL = 'analytics/daily.csv';
        const LEETCODE_BASE_URL = "https://leetcode.com/problems/";
        const GITHUB_BASE_URL = "https://github.com/joric/oneliners/blob/main/leetcode/";
        const DEFAULT_TITLE = "LeetCode Daily History";

        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });

        function fetchData() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processData(results.data);
                },
                error: function(err) {
                    document.getElementById('loading').textContent = "Error loading CSV: " + err.message;
                }
            });
        }

        function processData(rows) {
            const questions = {};
            const lastAppearance = {};
            const recurTimes = [];
            const counts = {}; 
            
            const diffMap = {"Easy": 0, "Medium": 1, "Hard": 2};
            const heatmapData = [[0,0,0,0,0,0,0], [0,0,0,0,0,0,0], [0,0,0,0,0,0,0]];
            const diffCounts = {"Easy": 0, "Medium": 0, "Hard": 0};
            
            const questionMeta = {};
            const calendarData = {};
            
            const searchIndex = [];
            const seenInSearch = new Set();
            const slugToIdMap = {};

            rows.forEach(row => {
                if (!row.date) return;
                
                const parts = row.date.split('-');
                const dObj = new Date(Date.UTC(parts[0], parts[1]-1, parts[2]));
                const qId = row.questionFrontendId;
                const difficulty = row.difficulty;
                const dayIdx = dObj.getUTCDay(); 

                if (diffMap[difficulty] !== undefined) {
                    const r = diffMap[difficulty];
                    heatmapData[r][dayIdx]++;
                    diffCounts[difficulty]++;
                }

                if (lastAppearance[qId]) {
                    const diffTime = Math.abs(dObj - lastAppearance[qId]);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    recurTimes.push(diffDays);
                }
                lastAppearance[qId] = dObj;

                counts[qId] = (counts[qId] || 0) + 1;
                
                if (!questionMeta[qId]) questionMeta[qId] = { count: 0, dates: [] };
                questionMeta[qId].count++;
                questionMeta[qId].dates.push(row.date);

                if (!seenInSearch.has(qId)) {
                    seenInSearch.add(qId);
                    if (row.titleSlug) {
                        slugToIdMap[row.titleSlug] = qId;
                    }
                    
                    searchIndex.push({
                        id: parseInt(qId),
                        idStr: qId,
                        title: row.title,
                        slug: row.titleSlug,
                        searchStr: (qId + " " + row.title + " " + row.titleSlug).toLowerCase(),
                        get count() { return questionMeta[qId]?.count ?? 0; },
                    });
                }

                const monthNames = ["January", "February", "March", "April", "May", "June",
                                  "July", "August", "September", "October", "November", "December"];
                const monthStr = `${monthNames[dObj.getUTCMonth()]} ${dObj.getUTCFullYear()}`;
                
                if (!calendarData[monthStr]) calendarData[monthStr] = {};
                calendarData[monthStr][dObj.getUTCDate()] = {
                    title: row.title,
                    slug: row.titleSlug,
                    diff: row.difficulty,
                    id: row.questionFrontendId
                };
            });

            searchIndex.sort((a, b) => a.id - b.id);

            // --- Calculations ---
            const heatmapPercents = [[0,0,0,0,0,0,0], [0,0,0,0,0,0,0], [0,0,0,0,0,0,0]];
            for(let r=0; r<3; r++) {
                const rowTotal = heatmapData[r].reduce((a,b) => a+b, 0);
                if (rowTotal > 0) {
                    for(let c=0; c<7; c++) {
                        heatmapPercents[r][c] = parseFloat(((heatmapData[r][c] / rowTotal) * 100).toFixed(2));
                    }
                }
            }

            const freqCounts = {};
            Object.values(counts).forEach(c => {
                freqCounts[c] = (freqCounts[c] || 0) + 1;
            });

            const totalDays = rows.length;
            const uniqueQuestions = Object.keys(counts).length;
            
            let avgRecurrence = 0;
            if (recurTimes.length > 0) {
                const sum = recurTimes.reduce((a, b) => a + b, 0);
                avgRecurrence = Math.round(sum / recurTimes.length);
            }
            
            const maxFreq = Math.max(...Object.keys(freqCounts).map(Number));
            const countAtMax = freqCounts[maxFreq] || 0;

            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            renderSummary(countAtMax, maxFreq, totalDays, uniqueQuestions, avgRecurrence);
            renderCharts(diffCounts, freqCounts, heatmapPercents, recurTimes);
            renderCalendar(calendarData, questionMeta);
            
            const taskDataMap = {}; 
            searchIndex.forEach(x => taskDataMap[x.idStr] = x);

            setupInteractions(taskDataMap); 
            setupSearch(searchIndex, taskDataMap);

            // Function to handle route changes based on hash
            const handleHashChange = () => {
                const hash = window.location.hash;
                if (hash && hash.length > 1) {
                    const slug = hash.substring(1);
                    if (slugToIdMap[slug]) {
                        const qId = slugToIdMap[slug];
                        // Pass false to applyLockAndFilter to prevent PUSHING new state, 
                        // just update UI to match current history state
                        applyLockAndFilter(qId, null, taskDataMap, false);
                    }
                } else {
                    // Hash cleared or empty
                    clearHighlights(false);
                }
            };

            // Handle Page Load (treat as history navigation so we don't push)
            handleHashChange();

            // Handle Browser History Navigation (Back/Forward)
            window.addEventListener('popstate', handleHashChange);

            requestAnimationFrame(() => {
                ['pieChart', 'freqChart', 'heatmapChart', 'recurChart'].forEach(id => {
                    Plotly.Plots.resize(document.getElementById(id));
                });
            });
        }

        function getLeetCodeTime(startDate = new Date('2020-03-31')) {
            const now = new Date();
            let y = now.getFullYear() - startDate.getFullYear();
            let m = now.getMonth() - startDate.getMonth();
            let d = now.getDate() - startDate.getDate();
            if (d < 0) {
                d += new Date(now.getFullYear(), now.getMonth(), 0).getDate();
                m--;
            }
            if (m < 0) {
                m += 12;
                y--;
            }
            return `${y} year${y!==1?'s':''}, ${m} month${m!==1?'s':''}, and ${d} day${d!==1?'s':''}`;
        }

        function renderSummary(countAtMax, maxFreq, totalDays, uniqueQuestions, avgRecur) {
            const html = `Out of ${totalDays} total days, there were ${uniqueQuestions} unique questions.
                          ${countAtMax} questions appeared ${maxFreq} times.<br>
                          Average time between reoccurrences: ${avgRecur} days.
                          ${getLeetCodeTime()} total.`;

            document.getElementById('summary').innerHTML = html;
        }

        function renderCharts(diffCounts, freqCounts, heatmapPercents, recurTimes) {
            const commonLayout = {
                autosize: true, 
                margin: { t: 60, b: 100, l: 60, r: 40 }, 
                hoverlabel: {
                    bgcolor: "#fff",
                    font: { color: "#000" },
                    bordercolor: "#333"
                },
            };
            const config = { responsive: true, displayModeBar: false };

            // 1. Pie
            Plotly.newPlot('pieChart', [{
                values: [diffCounts.Easy, diffCounts.Medium, diffCounts.Hard],
                labels: ['Easy', 'Medium', 'Hard'],
                type: 'pie',
                marker: { colors: ['#00b8a3', '#ffc01e', '#ff375f'] },
                textinfo: 'percent+value',
            }], { 
                ...commonLayout, 
                title: 'Daily Question Distribution',
                margin: { t: 80, b: 60, l: 20, r: 20 },
            }, config);

            // 2. Freq
            const freqKeys = Object.keys(freqCounts).map(Number).sort((a,b)=>a-b);
            const freqVals = freqKeys.map(k => freqCounts[k]);
            
            Plotly.newPlot('freqChart', [{
                x: freqKeys, y: freqVals, type: 'bar', marker: { color: '#448aff' }
            }], {
                ...commonLayout, 
                title: 'Question Frequency',
                xaxis: { title: 'Appearances', tickmode: 'linear', dtick: 1 },
                yaxis: { title: 'Count' }
            }, config);

            // 3. Heatmap
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const diffs = ['Easy', 'Medium', 'Hard'];
            const annotations = [];
            for (let i=0; i<3; i++) {
                for (let j=0; j<7; j++) {
                    annotations.push({
                        xref: 'x1', yref: 'y1', x: days[j], y: diffs[i],
                        text: Math.round(heatmapPercents[i][j]),
                        font: { color: heatmapPercents[i][j] > 50 ? 'white' : 'black' }, showarrow: false
                    });
                }
            }
            Plotly.newPlot('heatmapChart', [{
                z: heatmapPercents, x: days, y: diffs, type: 'heatmap', colorscale: 'Teal', showscale: true
            }], { 
                ...commonLayout, 
                title: 'Difficulty Day Frequency (%)', 
                annotations: annotations, 
                yaxis: { tickangle: -90 },
                margin: { ...commonLayout.margin, r: 50 } 
            }, config);

            // 4. Histogram
            Plotly.newPlot('recurChart', [{
                x: recurTimes, type: 'histogram', marker: { color: '#448aff' }, xbins: { size: 30 }
            }], {
                ...commonLayout, 
                title: 'Recurrence Days',
                xaxis: { title: 'Days' }, 
                yaxis: { title: 'Count' }
            }, config);
        }

        function renderCalendar(calendarData, questionMeta) {
            const container = document.getElementById('calendar');
            container.innerHTML = '';

            const sortedMonths = Object.keys(calendarData).sort((a, b) => new Date(b) - new Date(a));

            sortedMonths.forEach(monthStr => {
                const daysData = calendarData[monthStr];
                const dt = new Date(monthStr + " 1"); 
                const year = dt.getFullYear();
                const month = dt.getMonth(); 

                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startDayIdx = new Date(year, month, 1).getDay();

                const card = document.createElement('div');
                card.className = 'month-card';

                let html = `<div class="month-header">${monthStr}</div>
                            <div class="days-container">
                                <div class="day-name">Sun</div><div class="day-name">Mon</div><div class="day-name">Tue</div>
                                <div class="day-name">Wed</div><div class="day-name">Thu</div><div class="day-name">Fri</div><div class="day-name">Sat</div>`;

                for(let i=0; i<startDayIdx; i++) {
                    html += '<div class="day-cell empty"></div>';
                }

                for(let day=1; day<=daysInMonth; day++) {
                    if (daysData[day]) {
                        const info = daysData[day];
                        const diffClass = info.diff;
                        const qId = info.id;
                        
                        const githubLink = `${GITHUB_BASE_URL}${info.id}.${info.slug}.py`;
                        const leetcodeLink = `${LEETCODE_BASE_URL}${info.slug}/`;
                        
                        const meta = questionMeta[qId] || { count: 0, dates: [] };
                        const datesStr = meta.dates.join('\n');
                        const tooltip = `${info.id}. ${info.title}\nAppearances: ${meta.count}\nDates:\n${datesStr}`;

                        html += `<div class="day-cell ${diffClass}" title="${tooltip}" data-qid="${qId}">
                                    <a href="${leetcodeLink}" target="_blank" class="day-number">${day}</a>
                                    <a href="${githubLink}" target="_blank" class="occ-count">${meta.count}</a>
                                 </div>`;
                    } else {
                        html += `<div class="day-cell empty"><span class="day-number-static">${day}</span></div>`;
                    }
                }
                
                html += '</div>';
                card.innerHTML = html;
                container.appendChild(card);
            });
            
            window.addEventListener('resize', function() {
                const ids = ['pieChart', 'freqChart', 'heatmapChart', 'recurChart'];
                ids.forEach(id => Plotly.Plots.resize(document.getElementById(id)));
            });
        }

        // --- FILTERING AND LOCKING LOGIC ---
        let lockedQId = null; 
        
        function applyLockAndFilter(qId, targetElement, taskDataMap, pushToHistory = true) {
            lockedQId = qId;

            // Clear visuals but don't reset history inside this sub-call
            document.querySelectorAll('.highlight-clicked-active, .highlight-related').forEach(el => {
                el.classList.remove('highlight-clicked-active', 'highlight-related');
            });
            document.querySelectorAll('.month-card').forEach(el => {
                el.classList.remove('hidden'); 
            });
            
            const matches = document.querySelectorAll(`.day-cell[data-qid="${qId}"]`);
            
            matches.forEach((el, index) => {
                if (targetElement && el === targetElement) {
                    el.classList.add('highlight-clicked-active'); 
                } else if (!targetElement && index === 0) {
                     el.classList.add('highlight-clicked-active');
                } else {
                    el.classList.add('highlight-related'); 
                }
            });

            document.querySelectorAll('.month-card').forEach(card => {
                if (!card.querySelector(`.day-cell[data-qid="${qId}"]`)) {
                    card.classList.add('hidden');
                }
            });

            const input = document.getElementById('search-input');
            const clearBtn = document.getElementById('search-clear');
            
            const taskData = taskDataMap[qId];
            if (taskData) {
                input.value = '';
                input.placeholder = `#${qId} - ${taskData.title}`;
                input.classList.add('selected');
                clearBtn.style.display = 'block';
                
                // IMPORTANT: Set title BEFORE pushing state
                const newTitle = `${taskData.title} - LeetCode Daily`;
                document.title = newTitle;

                if (pushToHistory && taskData.slug) {
                    history.pushState({qId: qId}, newTitle, '#' + taskData.slug);
                }
            }
        }

        function clearHighlights(pushToHistory = true) {
            lockedQId = null;

            document.querySelectorAll('.highlight-clicked-active, .highlight-related').forEach(el => {
                el.classList.remove('highlight-clicked-active', 'highlight-related');
            });
            document.querySelectorAll('.month-card').forEach(el => {
                el.classList.remove('hidden');
            });

            const input = document.getElementById('search-input');
            const clearBtn = document.getElementById('search-clear');
            
            input.placeholder = "Search problems (e.g. 'Two Sum')...";
            input.classList.remove('selected');
            input.value = '';
            clearBtn.style.display = 'none';

            // IMPORTANT: Set title BEFORE pushing state
            document.title = DEFAULT_TITLE;

            if (pushToHistory) {
                history.pushState({}, DEFAULT_TITLE, window.location.pathname + window.location.search);
            }
        }

        function setupInteractions(taskDataMap) {
            const container = document.getElementById('calendar');

            const handleClick = (e) => {
                const targetCell = e.target.closest('.day-cell');
                const isLink = e.target.tagName === 'A';

                if (!targetCell || !targetCell.dataset.qid) {
                    return; 
                }

                const qId = targetCell.dataset.qid;
                const isSelected = targetCell.classList.contains('highlight-clicked-active');

                if (isLink) {
                    if (isSelected) {
                        return; // Allow link
                    } else {
                        e.preventDefault();
                        e.stopPropagation();
                        // This is a direct user action, so pushToHistory = true (default)
                        applyLockAndFilter(qId, targetCell, taskDataMap, true);
                    }
                } else {
                    if (!isSelected || lockedQId !== qId) {
                        e.preventDefault(); 
                        e.stopPropagation();
                        // This is a direct user action, so pushToHistory = true (default)
                        applyLockAndFilter(qId, targetCell, taskDataMap, true);
                    }
                }
            };

            container.addEventListener('click', handleClick);

            document.body.addEventListener('click', function(e) {
                if (!e.target.closest('.day-cell') && !e.target.closest('.search-wrapper')) {
                    // Direct user action to clear -> push state
                    clearHighlights(true);
                    document.getElementById('search-results').style.display = 'none';
                }
            });
        }

        // --- SEARCH FUNCTIONALITY ---
        function setupSearch(index, taskDataMap) {
            const input = document.getElementById('search-input');
            const resultsDiv = document.getElementById('search-results');
            const clearBtn = document.getElementById('search-clear');
            let currentFocus = -1;

            const closeAllLists = () => {
                currentFocus = -1;
                resultsDiv.style.display = 'none';
            };

            const addActive = (items) => {
                if (!items) return false;
                removeActive(items);
                if (currentFocus >= items.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (items.length - 1);
                items[currentFocus].classList.add("active");
                items[currentFocus].scrollIntoView({ block: 'nearest' });
            };

            const removeActive = (items) => {
                for (let i = 0; i < items.length; i++) {
                    items[i].classList.remove("active");
                }
            };

            input.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase().trim();
                currentFocus = -1;
                
                if (query.length > 0) {
                    clearBtn.style.display = 'block';
                } else {
                    if (!lockedQId) clearBtn.style.display = 'none';
                }

                if (query.length === 0) {
                    closeAllLists();
                    return;
                }

                const matches = index
                    .filter(item => item.searchStr.includes(query))
                    .sort((a, b) => a.id - b.id)
                    .slice(0, 10);

                if (matches.length > 0) {
                    let html = '';
                    matches.forEach(item => {
                        html += `<div class="search-item" data-qid="${item.idStr}">
                                    <span class="id">#${item.id}</span>
                                    <span class="title">${item.title}</span>
                                    <span class="count">${item.count}</span>
                                 </div>`;
                    });
                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';
                } else {
                    closeAllLists();
                }
            });

            input.addEventListener("keydown", function(e) {
                let items = resultsDiv.getElementsByClassName("search-item");
                if (e.key === "ArrowDown") {
                    currentFocus++;
                    addActive(items);
                } else if (e.key === "ArrowUp") {
                    currentFocus--;
                    addActive(items);
                } else if (e.key === "Enter") {
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (items) items[currentFocus].click();
                    }
                }
            });

            resultsDiv.addEventListener('click', function(e) {
                const item = e.target.closest('.search-item');
                if (item) {
                    const qId = item.dataset.qid; 
                    // User selection -> push state
                    applyLockAndFilter(qId, null, taskDataMap, true); 
                    closeAllLists();
                }
            });

            clearBtn.addEventListener('click', function(e) {
                // User explicit clear -> push state
                clearHighlights(true);
                closeAllLists();
            });
        }
    </script>
</body>
</html>
